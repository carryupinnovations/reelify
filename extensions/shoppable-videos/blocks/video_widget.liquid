
<div class="reelify-widget" data-shop-domain="{{ shop.permanent_domain }}" data-group="{{ block.settings.group }}">
  <div class="reelify-stories-container">
    <!-- Skeleton Loader -->
    <div class="reelify-skeleton-item">
       <div class="reelify-skeleton-ring"></div>
       <div class="reelify-skeleton-text"></div>
    </div>
    <div class="reelify-skeleton-item">
       <div class="reelify-skeleton-ring"></div>
       <div class="reelify-skeleton-text"></div>
    </div>
    <div class="reelify-skeleton-item">
       <div class="reelify-skeleton-ring"></div>
       <div class="reelify-skeleton-text"></div>
    </div>
  </div>
</div>

<div id="reelify-modal" class="reelify-modal">
  <div class="reelify-modal-content">
     <span class="reelify-close">&times;</span>
     <div class="reelify-video-wrapper">
        <video id="reelify-video-player" controls playsinline></video>
        <div id="reelify-product-overlay" class="reelify-product-overlay">
           <!-- Product details here -->
        </div>
     </div>
  </div>
</div>

<script>
(function() {
  const container = document.querySelector('.reelify-widget');
  if (!container) return;
})();
</script>

{% schema %}
{
  "name": "Shoppable Videos",
  "target": "section",
  "settings": [
     {
        "type": "text",
        "id": "app_url",
        "label": "App Base URL",
        "default": "https://your-app-url.com",
        "info": "Enter the URL where your app is hosted."
     },
     {
        "type": "text",
        "id": "group",
        "label": "Video Group",
        "default": "all",
        "info": "Filter videos by group name (e.g. 'home', 'product-page')."
     },
     {
        "type": "color",
        "id": "border_color",
        "label": "Border Color",
        "default": "#ff0055"
     }
  ]
}
{% endschema %}

<style>
  .reelify-stories-container {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 20px;
    scrollbar-width: none;
  }
  .reelify-story-item {
    flex: 0 0 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    animation: fadeIn 0.5s ease-in;
  }
  
  /* Skeleton */
  .reelify-skeleton-item {
      flex: 0 0 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
  }
  .reelify-skeleton-ring {
      width: 74px;
      height: 74px;
      border-radius: 50%;
      background: #eee;
      margin-bottom: 5px;
      animation: pulse 1.5s infinite;
  }
  .reelify-skeleton-text {
      width: 50px;
      height: 10px;
      background: #eee;
      border-radius: 4px;
      animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
  }
  @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
  }

  .reelify-story-ring {
    width: 74px;
    height: 74px;
    border-radius: 50%;
    padding: 2px;
    border: 2px solid {{ block.settings.border_color }};
  }
  .reelify-story-image {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
  }
  .reelify-story-title {
    font-size: 12px;
    margin-top: 5px;
    text-align: center;
    max-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Modal */
  .reelify-modal {
      display: none; 
      position: fixed; 
      z-index: 9999; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      background-color: rgba(0,0,0,0.8); 
  }
  .reelify-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 400px;
      height: 80%;
      background: #000;
  }
  .reelify-video-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
  }
  #reelify-video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  .reelify-close {
      position: absolute;
      top: 10px;
      right: 20px;
      color: #fff;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10001;
  }
  .reelify-product-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      display: none; /* Flex when active */
      align-items: center;
      gap: 10px;
  }
  .reelify-btn-add {
      background: black;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const container = document.querySelector('.reelify-stories-container');
    const widget = document.querySelector('.reelify-widget'); // Get wrapper to read settings
    const modal = document.getElementById('reelify-modal');
    const videoPlayer = document.getElementById('reelify-video-player');
    const closeBtn = document.querySelector('.reelify-close');
    const productOverlay = document.getElementById('reelify-product-overlay');
    
    if (!widget) return;

    // Get settings
    const appUrl = "{{ block.settings.app_url }}";
    const shop = "{{ shop.permanent_domain }}";
    const group = widget.dataset.group || "";

    if (!appUrl || appUrl.includes("your-app-url")) {
        console.warn("Reelify: Please configure App URL in Theme Editor");
        container.innerHTML = "<p>Please configure App URL</p>";
        return;
    }

    // Fetch videos
    const fetchUrl = `${appUrl}/api/videos?shop=${shop}&group=${group}`;
    
    fetch(fetchUrl)
        .then(res => res.json())
        .then(data => {
            if (data.videos && data.videos.length > 0) {
                renderStories(data.videos);
            } else {
                container.innerHTML = "<p style='padding:10px; color:#999'>No videos found for this group.</p>";
            }
        })
        .catch(err => {
            console.error("Reelify Fetch Error:", err);
            container.innerHTML = ""; // Hide skeleton on error
        });

    function renderStories(videos) {
        container.innerHTML = videos.map(video => `
            <div class="reelify-story-item" data-video='${JSON.stringify(video)}'>
                <div class="reelify-story-ring">
                    <img src="${video.thumbnail || ''}" alt="${video.title}" class="reelify-story-image">
                </div>
                <div class="reelify-story-title">${video.title || 'Video'}</div>
            </div>
        `).join('');

        // Add click listeners
        document.querySelectorAll('.reelify-story-item').forEach(item => {
            item.addEventListener('click', () => {
                const video = JSON.parse(item.dataset.video);
                openModal(video);
            });
        });
    }

    function openModal(video) {
        modal.style.display = "block";
        videoPlayer.src = video.url;
        videoPlayer.play();

        // Show product if tagged
        if (video.products && video.products.length > 0) {
            const tag = video.products[0]; // Just showing first one for MVP
            if (tag.handle) {
                fetch(`/products/${tag.handle}.js`)
                    .then(res => res.json())
                    .then(product => {
                         showProductOverlay(product, tag.variantId);
                    });
            }
        } else {
            productOverlay.style.display = "none";
        }
    }

    function showProductOverlay(product, variantId) {
        productOverlay.style.display = "flex";
        productOverlay.innerHTML = `
            <img src="${product.featured_image}" width="50" height="50" style="border-radius:4px">
            <div style="font-size:14px; font-weight:bold;">${product.title}</div>
            <button class="reelify-btn-add" onclick="addToCart(${product.variants[0].id})">Add</button>
        `;
        
        window.addToCart = (vid) => {
            fetch('/cart/add.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: [{ id: vid, quantity: 1 }] })
            })
            .then(() => {
                alert("Added to cart!");
            });
        };
    }

    closeBtn.onclick = function() {
        modal.style.display = "none";
        videoPlayer.pause();
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            videoPlayer.pause();
        }
    }
});
</script>
