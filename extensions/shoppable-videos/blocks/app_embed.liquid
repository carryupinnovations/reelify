
{% schema %}
{
  "name": "Shoppable Video Bubble",
  "target": "body",
  "settings": [
     {
        "type": "text",
        "id": "app_url",
        "label": "App Base URL",
        "default": "https://your-app-url.com",
        "info": "Enter the URL where your app is hosted."
     },
     {
        "type": "text",
        "id": "group",
        "label": "Video Group",
        "default": "all",
        "info": "Filter videos to show."
     },
    {
        "type": "header",
        "content": "Position"
    },
    {
        "type": "range",
        "id": "bottom_offset",
        "min": 0,
        "max": 100,
        "step": 5,
        "unit": "px",
        "label": "Bottom Offset",
        "default": 30
    },
    {
        "type": "range",
        "id": "side_offset",
        "min": 0,
        "max": 100,
        "step": 5,
        "unit": "px",
        "label": "Right Offset",
        "default": 30
    }
  ]
}
{% endschema %}

<div id="reelify-float-widget" class="reelify-float-widget" style="display:none; bottom:{{ block.settings.bottom_offset }}px; right:{{ block.settings.side_offset }}px;">
    <!-- Container for the first video or a bubble icon -->
    <div class="reelify-float-bubble">
         <!-- Injected via JS -->
    </div>
</div>

<div id="reelify-float-modal" class="reelify-modal">
  <div class="reelify-modal-content">
     <span class="reelify-close">&times;</span>
     <div class="reelify-video-wrapper">
        <video id="reelify-float-player" controls playsinline></video>
        <div id="reelify-float-overlay" class="reelify-product-overlay"></div>
     </div>
  </div>
</div>

<style>
  .reelify-float-widget {
      position: fixed;
      z-index: 9998;
      cursor: pointer;
  }
  .reelify-float-bubble {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #ff0055;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background: #000;
  }
  .reelify-float-bubble img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  
  /* Reuse Modal Styles */
  .reelify-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
  .reelify-modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 400px; height: 80%; background: #000; }
  .reelify-video-wrapper { position: relative; width: 100%; height: 100%; }
  #reelify-float-player { width: 100%; height: 100%; object-fit: cover; }
  .reelify-close { position: absolute; top: 10px; right: 20px; color: #fff; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 10001; }
  .reelify-product-overlay { position: absolute; bottom: 20px; left: 20px; right: 20px; background: white; padding: 10px; border-radius: 8px; display: none; align-items: center; gap: 10px; }
  .reelify-btn-add { background: black; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: auto; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const widget = document.getElementById('reelify-float-widget');
    const bubble = widget.querySelector('.reelify-float-bubble');
    const modal = document.getElementById('reelify-float-modal');
    const videoPlayer = document.getElementById('reelify-float-player');
    const closeBtn = modal.querySelector('.reelify-close');
    const productOverlay = document.getElementById('reelify-float-overlay');
    
    const appUrl = "{{ block.settings.app_url }}";
    const shop = "{{ shop.permanent_domain }}";
    const group = "{{ block.settings.group }}";

    if (!appUrl || appUrl.includes("your-app-url")) return;

    fetch(`${appUrl}/api/videos?shop=${shop}&group=${group}`)
        .then(res => res.json())
        .then(data => {
            if (data.videos && data.videos.length > 0) {
                // Just show the first video as the bubble entry point
                const firstVideo = data.videos[0];
                bubble.innerHTML = `<img src="${firstVideo.thumbnail}" alt="Watch">`;
                widget.style.display = "block";
                
                widget.onclick = () => openModal(firstVideo);
            }
        });

    function openModal(video) {
        modal.style.display = "block";
        videoPlayer.src = video.url;
        videoPlayer.play();
        
        // Very basic MVP: only handling the first video. 
        // Ideally, this should open a carousel of the videos in this group.
        
        if (video.products && video.products.length > 0) {
            const tag = video.products[0];
            if (tag.handle) {
                fetch(`/products/${tag.handle}.js`)
                    .then(res => res.json())
                    .then(product => {
                         showProductOverlay(product, tag.variantId);
                    });
            }
        }
    }

    function showProductOverlay(product, variantId) {
        productOverlay.style.display = "flex";
        productOverlay.innerHTML = `
            <img src="${product.featured_image}" width="50" height="50" style="border-radius:4px">
            <div style="font-size:14px; font-weight:bold;">${product.title}</div>
            <button class="reelify-btn-add" onclick="event.stopPropagation(); addToCart(${product.variants[0].id})">Add</button>
        `;
        
        window.addToCart = (vid) => {
             fetch('/cart/add.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: [{ id: vid, quantity: 1 }] })
            })
            .then(() => alert("Added to cart!"));
        };
    }

    closeBtn.onclick = function(e) {
        e.stopPropagation();
        modal.style.display = "none";
        videoPlayer.pause();
    }
});
</script>
